#!/bin/sh /etc/rc.common
# SPDX-License-Identifier: AGPL-3.0-or-later
# Based on original mwan3 by Florian Eckert <fe@dev.tdt.de>

readonly PKG_VERSION='dev'

. "${IPKG_INSTROOT}/lib/functions/network.sh"
. "${IPKG_INSTROOT}/lib/mwan4/mwan4.sh"
. "${IPKG_INSTROOT}/lib/mwan4/common.sh"

START=19
USE_PROCD=1
SCRIPTNAME="mwan4-init"

service_running() {
	[ -d "$MWAN4_STATUS_DIR" ]
}

start_tracker_family() {
	local interface="$1"
	local family="$2"

	procd_open_instance "track_${interface}_${family}"
	procd_set_param command /usr/sbin/mwan4track "$interface" "$family"
	procd_set_param respawn
	procd_close_instance
}

start_tracker() {
	local enabled interface
	interface=$1
	config_get_bool enabled "$interface" 'enabled' '0'
	[ $enabled -eq 0 ] && return
	[ -z "$(config_get $interface track_ip)" ] && return

	# Spawn tracker for each family
	mwan4_foreach_family "$interface" start_tracker_family
}

start_service() {
	local enabled hotplug_pids

	mwan4_init
	config_foreach start_tracker interface

	mwan4_update_iface_to_table
	mwan4_set_dynamic_nftset
	mwan4_set_connected_ipv4
	mwan4_set_connected_ipv6
	mwan4_set_custom_nftset
	mwan4_set_general_rules
	mwan4_set_general_nftables
	config_foreach mwan4_ifup interface "init"
	wait $hotplug_pids
	mwan4_set_policies_nftables
	mwan4_set_user_rules

	# Reload firewall4 to apply nftables configuration
	fw4 -q reload >/dev/null 2>&1 || LOG warn "Failed to reload fw4"

	procd_open_instance rtmon_ipv4
	procd_set_param command /usr/sbin/mwan4rtmon ipv4
	procd_set_param respawn
	procd_close_instance

	if [ $NO_IPV6 -eq 0 ]; then
		procd_open_instance rtmon_ipv6
		procd_set_param command /usr/sbin/mwan4rtmon ipv6
		procd_set_param respawn
		procd_close_instance
	fi
}

stop_service() {
	local rule IP family tid setname chainname

	mwan4_init
	config_foreach mwan4_interface_shutdown interface

	for family in ipv4 ipv6; do
		if [ "$family" = "ipv4" ]; then
			IP="$IP4"
		elif [ "$family" = "ipv6" ]; then
			[ $NO_IPV6 -ne 0 ] && continue
			IP="$IP6"
		fi

		# Flush routing tables
		for tid in $($IP route list table all | sed -ne 's/.*table \([0-9]\+\).*/\1/p' | sort -u); do
			[ $tid -gt $MWAN4_INTERFACE_MAX ] && continue
			$IP route flush table $tid &> /dev/null
		done

		# Delete IP rules
		for rule in $($IP rule list | grep -E '^[1-3][0-9]{3}:' | cut -d ':' -f 1); do
			$IP rule del pref $rule &> /dev/null
		done
	done

	# Clean up nftables chains and sets
	for chainname in $($nft list chains inet ${nftTable} 2>/dev/null | awk '{print $2}' | grep "^${nftPrefix}_"); do
		$nft delete chain inet ${nftTable} "$chainname" 2>/dev/null
	done

	for setname in $($nft list sets inet ${nftTable} 2>/dev/null | awk '{print $2}' | grep "^${nftPrefix}_"); do
		$nft delete set inet ${nftTable} "$setname" 2>/dev/null
	done

	# Remove nftables files
	rm -f "${nftMainFile}" "${nftIfaceFile}" "${nftPolicyFile}" "${nftRulesFile}"
	rm -f "${nftTempFile}"*

	# Reload firewall4 to clean up
	fw4 -q reload >/dev/null 2>&1 || true

	rm -rf $MWAN4_STATUS_DIR $MWAN4TRACK_STATUS_DIR
}

reload_service() {
	stop
	start
}

service_triggers() {
	procd_add_reload_trigger 'mwan4'
}
